<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Witness - WiFi Recovery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 420px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .connection-section {
            text-align: center;
            margin-bottom: 25px;
        }

        .connection-status {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .connection-status.disconnected {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px dashed #dee2e6;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }

        .form-section {
            opacity: 0.4;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .form-section.enabled {
            opacity: 1;
            pointer-events: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
            transform: translateY(-1px);
        }

        .form-group input:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .recovery-info {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .success-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #f1f3f4;
        }

        .success-info {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-animation {
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Smart Witness - WiFi Recovery</h1>
            <div class="subtitle">Recuperaci√≥n de Conexi√≥n WiFi</div>
        </div>

        <div class="content">
            <!-- WiFi Recovery Info -->
            <div class="recovery-info">
                <strong>‚ö†Ô∏è Modo de Recuperaci√≥n WiFi</strong><br>
                üì∂ Todas las redes WiFi configuradas han fallado<br>
                üîÑ El dispositivo est√° en modo BLE de recuperaci√≥n<br>
                ‚è±Ô∏è Tiempo l√≠mite: 2 minutos<br><br>
                <strong>‚úèÔ∏è Configura nueva red WiFi:</strong>
            </div>

            <!-- Connection Section -->
            <div class="connection-section">
                <div id="connection-status" class="connection-status disconnected">
                    üîç Buscando dispositivo en recovery...
                </div>
                
                <button id="connect-btn" class="btn btn-danger">
                    üîó Conectar con Dispositivo
                </button>
            </div>

            <!-- WiFi Configuration Form -->
            <div id="form-section" class="form-section">
                <div class="form-group">
                    <label for="ssid">Nueva Red WiFi</label>
                    <input type="text" id="ssid" placeholder="Nombre de la nueva red WiFi" disabled>
                </div>

                <div class="form-group">
                    <label for="password">Nueva Contrase√±a WiFi</label>
                    <input type="password" id="password" placeholder="Contrase√±a de la nueva red WiFi" disabled>
                </div>

                <!-- Save & Restart Button -->
                <button id="save-btn" class="btn btn-success" disabled>
                    üíæ Guardar y Reiniciar Dispositivo
                </button>

                <!-- OTA Button -->
                <button id="ota-btn" class="btn btn-warning" disabled>
                    üîÑ OTA Update
                </button>

                <!-- OTA Instructions Section -->
                <div id="ota-section" class="success-section hidden">
                    <div class="success-info">
                        üîÑ <strong>¬°Modo OTA Activado!</strong><br>
                        üì∂ Red WiFi creada para actualizaci√≥n<br>
                        ‚è∞ Recovery timeout cancelado<br><br>
                        
                        <strong>üìã Instrucciones:</strong><br>
                        1Ô∏è‚É£ Conecta tu PC a la red: <strong id="ota-network"></strong><br>
                        2Ô∏è‚É£ Password: <strong>12345678</strong><br>
                        3Ô∏è‚É£ Ve a: <strong>http://192.168.4.1:8080/ota</strong><br>
                        4Ô∏è‚É£ Selecciona archivo .bin y sube<br><br>
                        
                        <small>üí° El dispositivo se reiniciar√° autom√°ticamente despu√©s de la actualizaci√≥n</small>
                    </div>
                </div>

                <!-- Success Section -->
                <div id="success-section" class="success-section hidden">
                    <div class="success-info">
                        üéâ <strong>¬°WiFi Recovery Completado!</strong><br>
                        üíæ Nuevas credenciales WiFi guardadas<br>
                        üîÑ El dispositivo est√° reiniciando<br><br>
                        
                        <strong>üìã Pr√≥ximos pasos:</strong><br>
                        1Ô∏è‚É£ El ESP32 se reiniciar√° autom√°ticamente<br>
                        2Ô∏è‚É£ Intentar√° conectar con la nueva red WiFi<br>
                        3Ô∏è‚É£ Volver√° a modo operacional normal<br><br>
                        
                        <small>üí° El dispositivo puede tomar 30-60 segundos en conectar</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // BLE Configuration - Same UUIDs as main device
        const SERVICE_UUID = '12345678-1234-1234-1234-123456789abc';
        const CHAR_CONFIG_UUID = '87654321-4321-4321-4321-cba987654321';
        const CHAR_STATUS_UUID = '11111111-2222-3333-4444-555555555555';

        // Global variables
        let bleDevice = null;
        let bleServer = null;
        let configCharacteristic = null;
        let statusCharacteristic = null;
        let isConnected = false;

        // DOM Elements
        const connectBtn = document.getElementById('connect-btn');
        const connectionStatus = document.getElementById('connection-status');
        const formSection = document.getElementById('form-section');
        const ssidInput = document.getElementById('ssid');
        const passwordInput = document.getElementById('password');
        const saveBtn = document.getElementById('save-btn');
        const otaBtn = document.getElementById('ota-btn');
        const otaSection = document.getElementById('ota-section');
        const successSection = document.getElementById('success-section');

        // Recovery timeout variables
        let recoveryTimeoutCancelled = false;

        // Event Listeners
        connectBtn.addEventListener('click', connectToDevice);
        saveBtn.addEventListener('click', saveWiFiCredentials);
        otaBtn.addEventListener('click', startOTA);
        ssidInput.addEventListener('input', validateForm);
        passwordInput.addEventListener('input', validateForm);

        // Check browser compatibility
        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.bluetooth) {
                updateConnectionStatus('‚ùå Navegador no compatible con Bluetooth', 'disconnected');
                connectBtn.disabled = true;
                connectBtn.textContent = 'Navegador Incompatible';
            }
        });

        function updateConnectionStatus(message, state) {
            connectionStatus.textContent = message;
            connectionStatus.className = `connection-status ${state}`;
        }

        async function connectToDevice() {
            try {
                updateConnectionStatus('üîç Buscando dispositivo en recovery...', 'connecting');
                connectBtn.innerHTML = '<span class="loading-spinner"></span>Conectando...';
                connectBtn.disabled = true;

                // Request device - ONLY recovery devices
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'SmartWitness_RECOVERY_' }],
                    optionalServices: [SERVICE_UUID]
                });

                updateConnectionStatus(`üì± Conectando a ${bleDevice.name}...`, 'connecting');

                // Connect to GATT server
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                bleServer = await bleDevice.gatt.connect();

                // Get service and characteristics
                const service = await bleServer.getPrimaryService(SERVICE_UUID);
                
                configCharacteristic = await service.getCharacteristic(CHAR_CONFIG_UUID);
                
                try {
                    statusCharacteristic = await service.getCharacteristic(CHAR_STATUS_UUID);
                    await statusCharacteristic.startNotifications();
                    statusCharacteristic.addEventListener('characteristicvaluechanged', onStatusChanged);
                } catch (error) {
                    console.log('Status notifications not available');
                }

                // Connection successful
                isConnected = true;
                updateConnectionStatus(`‚úÖ Conectado a ${bleDevice.name}`, 'connected');
                connectionStatus.classList.add('success-animation');
                
                connectBtn.style.display = 'none';
                enableForm();

                console.log('Connected successfully to recovery device');

            } catch (error) {
                console.error('Connection error:', error);
                updateConnectionStatus('‚ùå Error de conexi√≥n', 'disconnected');
                connectBtn.innerHTML = 'üîó Conectar con Dispositivo';
                connectBtn.disabled = false;
            }
        }

        function enableForm() {
            formSection.classList.add('enabled');
            ssidInput.disabled = false;
            passwordInput.disabled = false;
            
            // Focus on first input
            setTimeout(() => ssidInput.focus(), 300);
        }

        function onStatusChanged(event) {
            const decoder = new TextDecoder();
            const status = decoder.decode(event.target.value);
            console.log('Status update:', status);

            switch (status) {
                case 'wifi_recovery_complete':
                    showSuccessSection();
                    break;
            }
        }

        function validateForm() {
            const hasSSID = ssidInput.value.trim().length > 0;
            const hasPassword = passwordInput.value.trim().length > 0;
            
            console.log('Form validation:', { hasSSID, hasPassword });
            
            saveBtn.disabled = !(hasSSID && hasPassword);
            
            // OTA button is enabled when device is connected (doesn't need form data)
            otaBtn.disabled = !isConnected || recoveryTimeoutCancelled;
            
            if (hasSSID && hasPassword) {
                saveBtn.classList.add('success-animation');
            }
        }

        async function saveWiFiCredentials() {
            if (!isConnected || !configCharacteristic) {
                alert('Dispositivo no conectado');
                return;
            }

            try {
                saveBtn.innerHTML = '<span class="loading-spinner"></span>Guardando...';
                saveBtn.disabled = true;

                updateConnectionStatus('üíæ Guardando nuevas credenciales WiFi...', 'connecting');

                // Send WiFi configuration to ESP32
                const config = {
                    ssid: ssidInput.value.trim(),
                    password: passwordInput.value.trim()
                };

                const configJson = JSON.stringify(config);
                const encoder = new TextEncoder();
                const data = encoder.encode(configJson);

                await configCharacteristic.writeValue(data);
                console.log('New WiFi credentials sent to ESP32 for recovery');
                
                saveBtn.innerHTML = '‚úÖ Credenciales Guardadas';
                updateConnectionStatus('‚úÖ Credenciales guardadas - dispositivo reiniciando', 'connected');

            } catch (error) {
                console.error('Save error:', error);
                saveBtn.innerHTML = '‚ùå Error al Guardar';
                setTimeout(() => {
                    saveBtn.innerHTML = 'üíæ Guardar y Reiniciar Dispositivo';
                    saveBtn.disabled = false;
                }, 3000);
            }
        }

        async function startOTA() {
            if (!isConnected || !configCharacteristic) {
                alert('Dispositivo no conectado');
                return;
            }

            try {
                otaBtn.innerHTML = '<span class="loading-spinner"></span>Activando OTA...';
                otaBtn.disabled = true;

                console.log('Starting OTA mode from recovery...');
                updateConnectionStatus('üîÑ Activando modo OTA...', 'connecting');

                // Cancel recovery timeout
                recoveryTimeoutCancelled = true;
                console.log('Recovery timeout cancelled for OTA mode');

                // Send OTA command via JSON to recovery device
                const otaCommand = {
                    action: "start_ota"
                };

                const commandJson = JSON.stringify(otaCommand);
                const encoder = new TextEncoder();
                const data = encoder.encode(commandJson);

                await configCharacteristic.writeValue(data);
                console.log('OTA command sent to ESP32 via recovery interface');
                
                // Show OTA instructions
                const otaNetwork = 'ESP32_OTA_' + bleDevice.name.split('_')[2]; // Extract MAC from RECOVERY name
                document.getElementById('ota-network').textContent = otaNetwork;
                
                otaBtn.innerHTML = '‚úÖ Modo OTA Activo';
                updateConnectionStatus('‚úÖ Modo OTA activado - recovery timeout cancelado', 'connected');
                
                otaSection.classList.remove('hidden');
                otaSection.scrollIntoView({ behavior: 'smooth' });

                // Disable save button since we're in OTA mode
                saveBtn.disabled = true;

            } catch (error) {
                console.error('OTA error:', error);
                otaBtn.innerHTML = '‚ùå Error OTA';
                recoveryTimeoutCancelled = false; // Restore timeout if OTA failed
                setTimeout(() => {
                    otaBtn.innerHTML = 'üîÑ OTA Update';
                    otaBtn.disabled = false;
                    validateForm(); // Re-enable save button
                }, 3000);
            }
        }

        function showSuccessSection() {
            successSection.classList.remove('hidden');
            successSection.scrollIntoView({ behavior: 'smooth' });
        }

        function onDisconnected() {
            console.log('Recovery device disconnected');
            isConnected = false;
            bleDevice = null;
            
            if (successSection.classList.contains('hidden')) {
                // Only show reconnect option if we haven't reached success phase
                updateConnectionStatus('üì± Dispositivo desconectado', 'disconnected');
                connectBtn.style.display = 'block';
                connectBtn.innerHTML = 'üîó Reconectar Dispositivo';
                connectBtn.disabled = false;
                
                // Disable form
                formSection.classList.remove('enabled');
                ssidInput.disabled = true;
                passwordInput.disabled = true;
                saveBtn.disabled = true;
            }
        }
    </script>
</body>
</html>
