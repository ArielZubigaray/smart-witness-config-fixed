<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Witness - Configuraci√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 420px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .connection-section {
            text-align: center;
            margin-bottom: 25px;
        }

        .connection-status {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .connection-status.disconnected {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px dashed #dee2e6;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(86, 171, 47, 0.4);
        }

        .form-section {
            opacity: 0.4;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .form-section.enabled {
            opacity: 1;
            pointer-events: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-group input:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .pin-display {
            text-align: center;
            margin: 25px 0;
        }

        .pin-display.enabled {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            padding: 20px;
            border-radius: 15px;
            transform: scale(1.02);
        }

        .pin-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .pin-value {
            font-size: 2.5em;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: #2d3436;
            letter-spacing: 0.1em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pin-instruction {
            font-size: 0.85em;
            color: #636e72;
            margin-top: 8px;
            font-style: italic;
        }

        .telegram-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #f1f3f4;
        }

        .telegram-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #0c5460;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-animation {
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .hidden {
            display: none;
        }

        .debug-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 0.8em;
            color: #666;
        }

        .debug-btn {
            margin-top: 5px;
            padding: 5px 10px;
            font-size: 0.75em;
            border: none;
            background: #6c757d;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .manual-pin-btn {
            padding: 5px 10px;
            margin-top: 5px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .pin-value {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∑ Smart Witness</h1>
            <div class="subtitle">Configuraci√≥n de Dispositivo</div>
        </div>

        <div class="content">
            <!-- Connection Section -->
            <div class="connection-section">
                <div id="connection-status" class="connection-status disconnected">
                    üîç Dispositivo no conectado
                </div>
                
                <button id="connect-btn" class="btn btn-primary">
                    üîó Conectar con Dispositivo
                </button>
            </div>

            <!-- Configuration Form -->
            <div id="form-section" class="form-section">
                <div class="form-group">
                    <label for="ssid">Red WiFi</label>
                    <input type="text" id="ssid" placeholder="Nombre de tu red WiFi" disabled>
                </div>

                <div class="form-group">
                    <label for="password">Contrase√±a WiFi</label>
                    <input type="password" id="password" placeholder="Contrase√±a de tu red WiFi" disabled>
                </div>

                <!-- PIN Display -->
                <div id="pin-display" class="pin-display">
                    <div class="pin-label">PIN del Dispositivo</div>
                    <div id="pin-value" class="pin-value">---</div>
                    <div id="pin-instruction" class="pin-instruction">Anota este n√∫mero para usarlo en Telegram</div>
                </div>

                <!-- Configure Button -->
                <button id="configure-btn" class="btn btn-success" disabled>
                    ‚öôÔ∏è Configurar Dispositivo
                </button>

                <!-- OTA Button -->
                <button id="ota-btn" class="btn btn-primary" disabled>
                    üîÑ OTA Update
                </button>

                <!-- OTA Instructions Section -->
                <div id="ota-section" class="telegram-section hidden">
                    <div class="telegram-info">
                        üîÑ <strong>¬°Modo OTA Activado!</strong><br>
                        üì∂ Red WiFi creada para actualizaci√≥n<br>
                        üîó Sigue estos pasos:<br><br>
                        
                        <strong>üìã Instrucciones:</strong><br>
                        1Ô∏è‚É£ Conecta tu PC a la red: <strong id="ota-network"></strong><br>
                        2Ô∏è‚É£ Password: <strong>12345678</strong><br>
                        3Ô∏è‚É£ Ve a: <strong>http://192.168.4.1:8080/ota</strong><br>
                        4Ô∏è‚É£ Selecciona archivo .bin y sube<br><br>
                        
                        <small>üí° El dispositivo se reiniciar√° autom√°ticamente despu√©s de la actualizaci√≥n</small>
                    </div>
                </div>

                <!-- Success Section (replaces telegram section) -->
                <div id="success-section" class="telegram-section hidden">
                    <div class="telegram-info">
                        üéâ <strong>¬°Configuraci√≥n enviada!</strong><br>
                        üì± Telegram se abri√≥ autom√°ticamente<br>
                        üîÑ El dispositivo se est√° reiniciando<br><br>
                        
                        <strong>üìã Pasos finales:</strong><br>
                        1Ô∏è‚É£ En Telegram, env√≠a: <strong>/start</strong> (si no se envi√≥ autom√°ticamente)<br>
                        2Ô∏è‚É£ Luego env√≠a tu PIN: <strong id="final-pin"></strong><br>
                        3Ô∏è‚É£ ¬°Configuraci√≥n completa!<br><br>
                        
                        <small>üí° El ESP32 est√° reiniciando - puede tomar 30-60 segundos estar listo</small>
                    </div>
                </div>

                <!-- Debug Section -->
                <div class="debug-section">
                    <strong>üîß Debug Info:</strong><br>
                    <div id="debug-info">Conecta el dispositivo para ver informaci√≥n de debug</div>
                    <button class="debug-btn" onclick="showDebugInfo()">Actualizar Debug</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // BLE Configuration
        const SERVICE_UUID = '12345678-1234-1234-1234-123456789abc';
        const CHAR_CONFIG_UUID = '87654321-4321-4321-4321-cba987654321';
        const CHAR_STATUS_UUID = '11111111-2222-3333-4444-555555555555';
        const CHAR_PIN_UUID = 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee';
        const CHAR_COMMAND_UUID = 'bbbbbbbb-cccc-dddd-eeee-ffffffffffff';

        // Global variables
        let bleDevice = null;
        let bleServer = null;
        let configCharacteristic = null;
        let statusCharacteristic = null;
        let pinCharacteristic = null;
        let commandCharacteristic = null;
        let isConnected = false;
        let devicePin = '';

        // DOM Elements
        const connectBtn = document.getElementById('connect-btn');
        const connectionStatus = document.getElementById('connection-status');
        const formSection = document.getElementById('form-section');
        const ssidInput = document.getElementById('ssid');
        const passwordInput = document.getElementById('password');
        const pinDisplay = document.getElementById('pin-display');
        const pinValue = document.getElementById('pin-value');
        const pinInstruction = document.getElementById('pin-instruction');
        const configureBtn = document.getElementById('configure-btn');
        const otaBtn = document.getElementById('ota-btn');
        const otaSection = document.getElementById('ota-section');
        const successSection = document.getElementById('success-section');

        // Event Listeners
        connectBtn.addEventListener('click', connectToDevice);
        configureBtn.addEventListener('click', configureDevice);
        otaBtn.addEventListener('click', startOTA);
        ssidInput.addEventListener('input', validateForm);
        passwordInput.addEventListener('input', validateForm);

        // Check browser compatibility
        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.bluetooth) {
                updateConnectionStatus('‚ùå Navegador no compatible con Bluetooth', 'disconnected');
                connectBtn.disabled = true;
                connectBtn.textContent = 'Navegador Incompatible';
            }
        });

        function updateConnectionStatus(message, state) {
            connectionStatus.textContent = message;
            connectionStatus.className = `connection-status ${state}`;
        }

        async function connectToDevice() {
            try {
                updateConnectionStatus('üîç Buscando dispositivo...', 'connecting');
                connectBtn.innerHTML = '<span class="loading-spinner"></span>Conectando...';
                connectBtn.disabled = true;

                // Request device
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'SmartWitness_' }],
                    optionalServices: [SERVICE_UUID]
                });

                updateConnectionStatus(`üì± Conectando a ${bleDevice.name}...`, 'connecting');

                // Connect to GATT server
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                bleServer = await bleDevice.gatt.connect();

                // Get service and characteristics
                const service = await bleServer.getPrimaryService(SERVICE_UUID);
                
                configCharacteristic = await service.getCharacteristic(CHAR_CONFIG_UUID);
                
                try {
                    statusCharacteristic = await service.getCharacteristic(CHAR_STATUS_UUID);
                    await statusCharacteristic.startNotifications();
                    statusCharacteristic.addEventListener('characteristicvaluechanged', onStatusChanged);
                } catch (error) {
                    console.log('Status notifications not available');
                }

                try {
                    pinCharacteristic = await service.getCharacteristic(CHAR_PIN_UUID);
                    await pinCharacteristic.startNotifications();
                    pinCharacteristic.addEventListener('characteristicvaluechanged', onPinReceived);
                    console.log('PIN notifications set up successfully');
                    
                    // Request current PIN value (in case it was already set)
                    try {
                        const pinData = await pinCharacteristic.readValue();
                        if (pinData.byteLength > 0) {
                            const decoder = new TextDecoder();
                            const existingPin = decoder.decode(pinData);
                            if (existingPin && existingPin !== '---' && existingPin.length === 3) {
                                onPinReceived({ target: { value: pinData } });
                            }
                        }
                    } catch (readError) {
                        console.log('Could not read existing PIN value');
                    }
                } catch (error) {
                    console.log('PIN notifications not available:', error);
                }

                try {
                    commandCharacteristic = await service.getCharacteristic(CHAR_COMMAND_UUID);
                } catch (error) {
                    console.log('Command characteristic not available');
                }

                // Connection successful
                isConnected = true;
                updateConnectionStatus(`‚úÖ Conectado a ${bleDevice.name}`, 'connected');
                connectionStatus.classList.add('success-animation');
                
                connectBtn.style.display = 'none';
                enableForm();

                // Set up PIN request timeout (if PIN not received in 10 seconds)
                setTimeout(() => {
                    if (!devicePin || devicePin === '---') {
                        console.log('PIN not received automatically, showing manual option');
                        showManualPinOption();
                    }
                }, 10000);

                console.log('Connected successfully, waiting for PIN...');

            } catch (error) {
                console.error('Connection error:', error);
                updateConnectionStatus('‚ùå Error de conexi√≥n', 'disconnected');
                connectBtn.innerHTML = 'üîó Conectar con Dispositivo';
                connectBtn.disabled = false;
            }
        }

        function enableForm() {
            formSection.classList.add('enabled');
            ssidInput.disabled = false;
            passwordInput.disabled = false;
            
            // Focus on first input
            setTimeout(() => ssidInput.focus(), 300);
        }

        function showManualPinOption() {
            pinInstruction.innerHTML = 
                '‚ö†Ô∏è PIN no recibido autom√°ticamente<br><button class="manual-pin-btn" onclick="requestPinManually()">üîÑ Solicitar PIN</button>';
        }

        function requestPinManually() {
            if (pinCharacteristic) {
                console.log('Manually requesting PIN...');
                pinCharacteristic.readValue().then(data => {
                    if (data.byteLength > 0) {
                        onPinReceived({ target: { value: data } });
                    }
                }).catch(error => {
                    console.log('Manual PIN request failed:', error);
                    pinInstruction.innerHTML = '‚ùå No se pudo obtener PIN. Verifica la conexi√≥n.';
                });
            }
        }

        function onPinReceived(event) {
            const decoder = new TextDecoder();
            const receivedPin = decoder.decode(event.target.value);
            
            console.log('PIN received event:', receivedPin, 'length:', receivedPin.length);
            
            // Validate PIN format (should be 3 digits)
            if (receivedPin && receivedPin.length === 3 && /^\d{3}$/.test(receivedPin)) {
                devicePin = receivedPin;
                
                console.log('Valid PIN received:', devicePin);
                
                pinValue.textContent = devicePin;
                pinDisplay.classList.add('enabled');
                pinDisplay.classList.add('success-animation');
                
                // Update instruction
                pinInstruction.textContent = `‚úÖ PIN recibido: ${devicePin} - An√≥talo para Telegram`;
                
                validateForm();
                
                // Remove any manual request option
                const manualBtn = pinDisplay.querySelector('.manual-pin-btn');
                if (manualBtn) {
                    manualBtn.remove();
                }
                
            } else {
                console.log('Invalid PIN received:', receivedPin);
                if (receivedPin && receivedPin !== '---') {
                    pinInstruction.textContent = `‚ö†Ô∏è PIN inv√°lido recibido: "${receivedPin}" (esperado: 3 d√≠gitos)`;
                }
            }
        }

        function onStatusChanged(event) {
            const decoder = new TextDecoder();
            const status = decoder.decode(event.target.value);
            console.log('Status update:', status);

            switch (status) {
                case 'config_complete_with_pin':
                    showTelegramSection();
                    break;
                case 'telegram_opened_restarting':
                    updateConnectionStatus('üîÑ Dispositivo reiniciando...', 'connecting');
                    showRestartMessage();
                    break;
            }
        }

        function validateForm() {
            const hasSSID = ssidInput.value.trim().length > 0;
            const hasPassword = passwordInput.value.trim().length > 0;
            const hasPin = devicePin && devicePin !== '---' && devicePin.length === 3;
            
            console.log('Form validation:', { hasSSID, hasPassword, hasPin, devicePin });
            
            configureBtn.disabled = !(hasSSID && hasPassword && hasPin);
            
            // OTA button is enabled when device is connected (doesn't need form data)
            otaBtn.disabled = !isConnected;
            
            if (hasSSID && hasPassword && hasPin) {
                configureBtn.classList.add('success-animation');
            }
        }

        async function configureDevice() {
            if (!isConnected || !configCharacteristic) {
                alert('Dispositivo no conectado');
                return;
            }

            try {
                configureBtn.innerHTML = '<span class="loading-spinner"></span>Configurando...';
                configureBtn.disabled = true;

                // üöÄ PASO 1: ABRIR TELEGRAM INMEDIATAMENTE (sin esperar nada)
                console.log('Opening Telegram immediately...');
                const telegramUrl = `https://t.me/SWEsp32cam_bot?text=/start`;
                const telegramWindow = window.open(telegramUrl, '_blank');
                
                if (!telegramWindow) {
                    // Popup blocked, try simple URL
                    window.open('https://t.me/SWEsp32cam_bot', '_blank');
                    updateConnectionStatus('üì± Abre Telegram manualmente si no se abri√≥ autom√°ticamente', 'connecting');
                } else {
                    updateConnectionStatus('üì± Telegram abierto - env√≠a /start si no se envi√≥ autom√°ticamente', 'connected');
                }

                // üöÄ PASO 2: Enviar configuraci√≥n WiFi al ESP32
                const config = {
                    ssid: ssidInput.value.trim(),
                    password: passwordInput.value.trim()
                };

                const configJson = JSON.stringify(config);
                const encoder = new TextEncoder();
                const data = encoder.encode(configJson);

                await configCharacteristic.writeValue(data);
                console.log('WiFi configuration sent to ESP32');
                
                // üöÄ PASO 3: Enviar comando de reinicio al ESP32
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (commandCharacteristic) {
                    try {
                        await commandCharacteristic.writeValue(encoder.encode('telegram_opened'));
                        console.log('Restart command sent to ESP32');
                    } catch (error) {
                        console.log('Could not send restart command:', error);
                    }
                }

                // üöÄ PASO 4: Mostrar instrucciones finales
                configureBtn.innerHTML = '‚úÖ Configuraci√≥n Enviada';
                showSuccessSection();

            } catch (error) {
                console.error('Configuration error:', error);
                configureBtn.innerHTML = '‚ùå Error de Configuraci√≥n';
                setTimeout(() => {
                    configureBtn.innerHTML = '‚öôÔ∏è Configurar Dispositivo';
                    configureBtn.disabled = false;
                }, 3000);
            }
        }

        function showTelegramSection() {
            telegramSection.classList.remove('hidden');
            telegramSection.scrollIntoView({ behavior: 'smooth' });
        }

        async function startOTA() {
            if (!isConnected || !commandCharacteristic) {
                alert('Dispositivo no conectado');
                return;
            }

            try {
                otaBtn.innerHTML = '<span class="loading-spinner"></span>Activando OTA...';
                otaBtn.disabled = true;

                console.log('Starting OTA mode...');
                updateConnectionStatus('üîÑ Activando modo OTA...', 'connecting');

                // Send OTA command to ESP32
                const encoder = new TextEncoder();
                await commandCharacteristic.writeValue(encoder.encode('start_ota'));
                console.log('OTA command sent to ESP32');
                
                // Show OTA instructions
                const otaNetwork = 'ESP32_OTA_' + bleDevice.name.split('_')[1]; // Extract MAC part
                document.getElementById('ota-network').textContent = otaNetwork;
                
                otaBtn.innerHTML = '‚úÖ Modo OTA Activo';
                updateConnectionStatus('‚úÖ Modo OTA activado - sigue las instrucciones', 'connected');
                
                otaSection.classList.remove('hidden');
                otaSection.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('OTA error:', error);
                otaBtn.innerHTML = '‚ùå Error OTA';
                setTimeout(() => {
                    otaBtn.innerHTML = 'üîÑ OTA Update';
                    otaBtn.disabled = false;
                }, 3000);
            }
        }

        function showRestartMessage() {
            connectionStatus.innerHTML = 'üîÑ Dispositivo reiniciando...<br><small>Abrir Telegram y enviar PIN: ' + devicePin + '</small>';
        }

        async function openTelegram() {
            // Send command to device that telegram is being opened
            if (commandCharacteristic) {
                try {
                    const encoder = new TextEncoder();
                    await commandCharacteristic.writeValue(encoder.encode('telegram_opened'));
                } catch (error) {
                    console.log('Could not send telegram_opened command');
                }
            }

            // Open Telegram
            const telegramUrl = 'https://t.me/SmartWitnessBot';
            window.open(telegramUrl, '_blank');
            
            // Update button state
            telegramBtn.innerHTML = '‚úÖ Telegram Abierto';
            telegramBtn.disabled = true;
            
            // Show final instructions
            setTimeout(() => {
                updateConnectionStatus(`‚úÖ Configuraci√≥n completa. Env√≠a "${devicePin}" en Telegram`, 'connected');
            }, 1000);
        }

        function showSuccessSection() {
            document.getElementById('final-pin').textContent = devicePin;
            successSection.classList.remove('hidden');
            successSection.scrollIntoView({ behavior: 'smooth' });
        }

        function onDisconnected() {
            console.log('Device disconnected');
            isConnected = false;
            bleDevice = null;
            
            if (successSection.classList.contains('hidden')) {
                // Only show reconnect option if we haven't reached success phase
                updateConnectionStatus('üì± Dispositivo desconectado', 'disconnected');
                connectBtn.style.display = 'block';
                connectBtn.innerHTML = 'üîó Reconectar Dispositivo';
                connectBtn.disabled = false;
                
                // Disable form
                formSection.classList.remove('enabled');
                ssidInput.disabled = true;
                passwordInput.disabled = true;
                configureBtn.disabled = true;
                
                // Reset PIN display
                pinValue.textContent = '---';
                pinDisplay.classList.remove('enabled');
                devicePin = '';
            }
        }

        // Debug function
        function showDebugInfo() {
            const debugElement = document.getElementById('debug-info');
            debugElement.innerHTML = `
                Conectado: ${isConnected}<br>
                PIN: "${devicePin}" (length: ${devicePin ? devicePin.length : 0})<br>
                SSID: "${ssidInput.value}"<br>
                Password: "${passwordInput.value ? '***' : ''}"<br>
                BLE Device: ${bleDevice ? bleDevice.name : 'null'}<br>
                PIN Char: ${pinCharacteristic ? 'available' : 'null'}
            `;
        }

        // Make functions globally available
        window.showDebugInfo = showDebugInfo;
        window.requestPinManually = requestPinManually;
    </script>
</body>
</html>
